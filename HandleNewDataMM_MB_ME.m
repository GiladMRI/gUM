FN='/home/a/SpiralData/27Apr18/meas_MID80_gSpiral_BOLD_1Sli_1Rep_1Shot_VD10_6ADCs_25_125_FID15656.dat';
FN='/home/a/SpiralData/27Apr18/meas_MID78_gSpiral_BOLD_1Sli_1Rep_1Shot_VD13_6ADCs_25_125_FID15654.dat';
FN='/home/a/SpiralData/27Apr18/meas_MID85_gSpiral_BOLD_1Sli_1Rep_2Shot_VD10_4ADCs_25_125_FID15660.dat';
FN='/home/a/SpiralData/27Apr18/meas_MID87_gSpiral_BOLD_1Sli_4Rep_2Shot_VD10_4ADCs_25_125_FID15662.dat';

FN='/media/a/DATA1/13May18/Phantom/meas_MID364_gBP_VD11_U19_FID17753.dat';
FN='/media/a/DATA1/13May18/Phantom/meas_MID366_gBP_VD11_U10_FID17755.dat';
FN='/media/a/DATA1/13May18/Me/meas_MID407_gBP_VD11_U10_FID17796.dat';
FN='/media/a/DATA1/13May18/Me/meas_MID405_gBP_VD11_U19_FID17794.dat';
FN='/media/a/DATA1/13May18/Me/meas_MID417_gBP_VD15_U20_FID17806.dat';
FN='/media/a/DATA1/13May18/Me/meas_MID426_gBP_VD11_U19_A35S155_FID17815.dat';
FN='/media/a/DATA1/13May18/Me/meas_MID409_gBP_VD11_U19_7ADCs_FID17798.dat';

% FN='/media/a/DATA/14May18/Ben/meas_MID107_gBP_VD11_U19_FID17942.dat';

FN='/media/a/DATA/14May18/Ben/meas_MID109_gBP_VD11_U19_4min_FID17944.dat';

ScanP='/media/a/DATA/13May18/Me/';
BaseFN='meas_MID409_gBP_VD11_U19_7ADCs_FID17798';
RefFldMapP='/media/a/DATA/13May18/Me/meas_MID399_BP_fieldmap_4echos_FID17788/';

% ScanP='/media/a/DATA/14May18/Ben/';
% BaseFN='meas_MID111_gBP_VD11_U19_G35S155_FID17946';
% BaseFN='meas_MID109_gBP_VD11_U19_4min_FID17944';
% RefFldMapP='/media/a/DATA/14May18/Ben/meas_MID123_BP_fieldmap_5echosX_FID17958/';
% 
% BaseP='/media/a/DATA/180628_AK/';
% ScanP='/media/a/DATA/180628_AK/';
% RefFldMapP='/media/a/DATA/180628_AK/meas_MID265_BP_fieldmap_5echosX_FID22460/';
% BaseFN='meas_MID244_gBP_VD11_U19_G35S155_4min_FID22439';

ScanP='/media/a/DATA/11Jul18/RL/';
BaseFN='meas_MID149_gBP_VD11_U19_G35S155_FID23846';
RefFldMapP='/media/a/DATA/11Jul18/RL/meas_MID141_BP_fieldmap_5echosX_FID23838/';

% ScanP='/media/a/DATA/PhantomCAIPI/';
% RefFldMapP='/media/a/DATA/PhantomCAIPI/meas_MID330_BP_fieldmap_5echosX_FID24027/';
% BaseFN='meas_MID342_gBP_Spi_12Sli_MB2_FID24036';
% BaseFN='meas_MID344_gBP_Spi_12Sli_MB2_Cs36_FID24038';

ScanP='/media/a/DATA/ASLSubjData/S04/';
BaseFN='meas_MID149_gBP_VD11_U19_G35S155_FID23846';
RefFldMapP='/media/a/DATA/ASLSubjData/S04/meas_MID141_BP_fieldmap_5echosX_FID23838/';
% BaseFN='meas_MID164_gBP_VD11_U27_G35S155_2ADCs_FID23861';

% ScanP='/media/a/DATA/ASLSubjData/S03/';
% BaseFN='meas_MID244_gBP_VD11_U19_G35S155_4min_FID22439';
% RefFldMapP='/media/a/DATA/ASLSubjData/S03/meas_MID265_BP_fieldmap_5echosX_FID22460/';

% ScanP='/media/a/DATA/ASLSubjData/S02/';
% BaseFN='meas_MID109_gBP_VD11_U19_4min_FID17944';
% RefFldMapP='/media/a/DATA/ASLSubjData/S02/meas_MID123_BP_fieldmap_5echosX_FID17958/';

% ScanP='/media/a/DATA/ASLSubjData/S01/';
% BaseFN='meas_MID409_gBP_VD11_U19_7ADCs_FID17798';
% RefFldMapP='/media/a/DATA/ASLSubjData/S01/meas_MID399_BP_fieldmap_4echos_FID17788/';

ScanP='/media/a/DATA/FC/';
% BaseFN='meas_MID203_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_OutInOut_FID24589';
RefFldMapP='/media/a/DATA/FC/meas_MID197_BP_fieldmap_5echosX_FID24583/';
BaseFN='meas_MID199_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_MB_CAIPI36_FID24585';

ScanP='/media/a/DATA/DI_AK_ObliqueMBOutInOut/';
BaseFN='meas_MID169_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_FID25539';
RefFldMapP='/media/a/DATA/DI_AK_ObliqueMBOutInOut/meas_MID167_BP_fieldmap_5echosX_FID25537/';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/';
BaseFN='meas_MID486_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_FID26054';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/meas_MID484_BP_fieldmap_5echosX_FID26052/';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/DeeperRegion/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/DeeperRegion/meas_MID507_BP_fieldmap_5echosX_FID26075';
BaseFN='meas_MID521_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_OutInOut3ADCs_FID26089';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/DeeperRegion/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/DeeperRegion/meas_MID507_BP_fieldmap_5echosX_FID26075/';
BaseFN='meas_MID524_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_OutInOut3ADCs_FID26092';


ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/meas_MID484_BP_fieldmap_5echosX_FID26052';
BaseFN='meas_MID496_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_FID26064';


ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/meas_MID484_BP_fieldmap_5echosX_FID26052/';
BaseFN='meas_MID486_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_FID26054';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/DeeperRegion/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/DeeperRegion/meas_MID507_BP_fieldmap_5echosX_FID26075/';
BaseFN='meas_MID509_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_FID26077';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/meas_MID484_BP_fieldmap_5echosX_FID26052/';
BaseFN='meas_MID488_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_4min_FID26056';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnSK_17Aug18/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnSK_17Aug18/meas_MID35_BP_fieldmap_5echosX_FID27238/';
BaseFN='meas_MID66_gBP_ep2d_MB_U24_VD11_C200_OutInOut_FID27269';

ScanP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/Sep19_Deni/';
RefFldMapP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/Sep19_Deni/meas_MID537_BP_fieldmap_5echosX_FID30388/';
BaseFN='meas_MID543_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_4min_FID30394';

MIDStr=BaseFN(6:11);
FN=[ScanP BaseFN '.dat'];
%%
WhichE=2;

mainP=[ScanP BaseFN '_E' num2str(WhichE)];
mkdir(mainP);

system(['sudo chmod +777 -R ' mainP]);
%% Read raw
AData = mapVBVD(FN);
% ADataI=AData.image();
ADataIsL=AData.image(:,:,:,:,:,3,:,:,:,:,:,:,:);
% ADataIs=squeeze(ADataI);
% ADataIs=ADataIs(ADataIs(:,:,:,3,:)); % remove weird dimension with zeros
% ADataIs=squeeze(ADataIs);
ADataIsL=squeeze(ADataIsL);

for i=1:numel(AData.hdr.Phoenix.sSliceArray.asSlice)
    %SLoc(i,1)=AData.hdr.Phoenix.sSliceArray.asSlice{i}.sPosition.dSag;
    SLoc(i,2)=AData.hdr.Phoenix.sSliceArray.asSlice{i}.sPosition.dCor;
    SLoc(i,3)=AData.hdr.Phoenix.sSliceArray.asSlice{i}.sPosition.dTra;
end

asSlice=AData.hdr.Phoenix.sSliceArray.asSlice;
if(iscell(asSlice(1)))
    asSlice=[AData.hdr.Phoenix.sSliceArray.asSlice{:}];
end

nSlices=numel(AData.hdr.Phoenix.sSliceArray.asSlice);
% nSlices=numel(asSlice);
for s=1:nSlices
    try
        SlbLoc(1,s)=asSlice(s).sPosition.dSag;
    catch
        SlbLoc(1,s)=0;
    end
    try
        SlbLoc(2,s)=asSlice(s).sPosition.dCor;
    catch
        SlbLoc(2,s)=0;
    end
    try
        SlbLoc(3,s)=asSlice(s).sPosition.dTra;
    catch
        SlbLoc(3,s)=0;
    end
end

RotMat = transpose(Quat2RotMat(AData.image.slicePos(4:7, 100)));
RotatedLocs=RotMat.'*SlbLoc;

[U IA IB]=unique(AData.image.slicePos(3,:));
Qoffset=AData.image.slicePos(1:3,IA);

% nSlices=numel(AData.hdr.Phoenix.sSliceArray.asSlice);
% Ord=[1:2:nSlices 2:2:nSlices];
Ord=[2:2:nSlices 1:2:nSlices];
[~,ROrd]=sort(Ord);


FOVx=AData.hdr.Meas.ReadFOV;
dFOV=FOVx/1000;

paramLongROSamples = AData.hdr.MeasYaps.sWiPMemBlock.alFree{20};
spBW =AData.hdr.MeasYaps.sWiPMemBlock.adFree{13};
AccR =AData.hdr.MeasYaps.sWiPMemBlock.adFree{6};
paramLongInterleaves =AData.hdr.MeasYaps.sWiPMemBlock.adFree{8};
VD =AData.hdr.MeasYaps.sWiPMemBlock.adFree{5};
paramLongSpGradAmp =AData.hdr.MeasYaps.sWiPMemBlock.adFree{11};
paramLongSpSlewRate =AData.hdr.MeasYaps.sWiPMemBlock.adFree{10};
MB=AData.hdr.MeasYaps.sWiPMemBlock.alFree{9};

CAIPISep_mm=AData.hdr.MeasYaps.sWiPMemBlock.adFree{7};
CAIPIPeriod_us=AData.hdr.MeasYaps.sWiPMemBlock.adFree{8};
CAIPIDelay_us=AData.hdr.MeasYaps.sWiPMemBlock.adFree{9};
% MB
nSlicesNoMB=nSlices/MB;

% if(MB>1)
if(isempty(spBW))
    spBW =AData.hdr.MeasYaps.sWiPMemBlock.adFree{14};
    paramLongInterleaves =AData.hdr.MeasYaps.sWiPMemBlock.adFree{10};
    paramLongSpGradAmp =AData.hdr.MeasYaps.sWiPMemBlock.adFree{12};
    paramLongSpSlewRate =AData.hdr.MeasYaps.sWiPMemBlock.adFree{11};
end
disp('Read data');
%%
SummaryStr.MB=MB;
SummaryStr.paramLongSpGradAmp=paramLongSpGradAmp;
SummaryStr.paramLongSpSlewRate=paramLongSpSlewRate;
SummaryStr.paramLongROSamples =paramLongROSamples;
SummaryStr.spBW=spBW;
SummaryStr.AccR=AccR;
SummaryStr.paramLongInterleaves=paramLongInterleaves;
SummaryStr.VD=VD;

if(MB>1)
    SummaryStr.CAIPISep_mm=CAIPISep_mm;
    SummaryStr.CAIPIPeriod_us=CAIPIPeriod_us;
    SummaryStr.CAIPIDelay_us=CAIPIDelay_us;
end
%%
save([mainP filesep 'Data.mat'],'ADataIsL','AData');
disp(['Saved ' [mainP filesep 'Data.mat']]);
%%
% save('StatusForTrajDesign1Band_2.mat');
%% given everything but VD and Acc
% OutInOut=false;
OutInOut=paramLongROSamples>9000;
if(OutInOut)
    [kTraj, BaseRes, GradBuf, MaxGrad]=VDSpiralMex([dFOV,paramLongROSamples/3,spBW,AccR,...
    paramLongInterleaves,VD,paramLongSpGradAmp,paramLongSpSlewRate,1]);
else
    [kTraj, BaseRes, GradBuf, MaxGrad]=VDSpiralMex([dFOV,paramLongROSamples,spBW,AccR,...
        paramLongInterleaves,VD,paramLongSpGradAmp,paramLongSpSlewRate,0]);
end

CAIPIVec=CAIPIBlips([paramLongSpGradAmp, paramLongSpSlewRate,CAIPISep_mm,CAIPIDelay_us,CAIPIPeriod_us,...
    2560*paramLongROSamples/1024]);

gamma=42.5774806;
cCAIPIVec=cumsum(CAIPIVec)*gamma*10*2*pi/1e6;

if(OutInOut)
    BaseLen=size(kTraj,1)/3;
    TrajIdxs=(1:BaseLen)+BaseLen*(WhichE-1);
    kTraj=kTraj(TrajIdxs,:);
    GradBuf=GradBuf(TrajIdxs,:);
    
    CAIPIVec=CAIPIVec(TrajIdxs,:);
    cCAIPIVec=cCAIPIVec(TrajIdxs,:);
end


EffMaxRes=sqrt(sum(((kTraj(end,:))*FOVx/2/pi/1000).^2))*2;

clear kTrajQ
kTrajQ(:,1) = interp1(1:size(kTraj,1),kTraj(:,1),1:1e5/spBW:(size(kTraj,1)-0.01));
kTrajQ(:,2) = interp1(1:size(kTraj,1),kTraj(:,2),1:1e5/spBW:(size(kTraj,1)-0.01));

BARTTrajx=kTrajQ.'*FOVx/1000/2/pi;
BARTTrajx(3,end)=0;

BARTTrajMS=BARTTrajx;
BARTTrajxC=BARTTrajx(1,:)+1i*BARTTrajx(2,:);
for i=2:paramLongInterleaves
    CurRotTrajC=BARTTrajxC*exp(1i*2*pi*(i-1)/paramLongInterleaves);
    BARTTrajMS(1,:,i)=real(CurRotTrajC);
    BARTTrajMS(2,:,i)=imag(CurRotTrajC);
end
BARTTrajMS(3,end)=0;
disp('ok 1');
%%
MaxK=max(BARTTrajMS(:));
nTraj=size(BARTTrajMS,2);
Acc=ceil(MaxK*2).^2/nTraj;
XResmm=dFOV*1000/(2*MaxK);
figure;subplot(2,2,1);
plot(BARTTrajMS(1,:),BARTTrajMS(2,:),'.')
setXaxis([-1.1 1.1]*ceil(MaxK));

setYaxis([-1.1 1.1]*ceil(MaxK));
title(['MaxK=' num2str(MaxK) ' #Traj=' num2str(nTraj) ' Acc=' num2str(Acc) ]);
xlabel(['Res ' num2str(XResmm,'%.2f') 'mm']);
ylabel(['Nominal acc: ' num2str(AccR) ' VD=' num2str(VD)]);

subplot(2,2,2);
plot(GradBuf*MaxGrad*1000);title(['                Grad, max=' num2str(MaxGrad*1000,'%.2f') 'mT/m'])
SlewBuf=diff(GradBuf*MaxGrad*1000,[],1);
hold on;
plot(CAIPIVec,'k');
subplot(2,2,4);
plot(SlewBuf*100);MaxSlew=max(max(abs(SlewBuf(20:end,:))));
title(['Slew, max~=' num2str(MaxSlew*100,'%.2f') 'mT/m/s'])
subplot(2,2,3);
plot(cumsum(CAIPIVec));
title('CAIPI cumsum');
%%
Traj3=BARTTrajMS;

CAIPIkI = interp1(1:size(kTraj,1),cumsum(CAIPIVec),1:1e5/spBW:(size(kTraj,1)-0.01));

Traj3(3,:)=CAIPIkI;
figure;plot3(Traj3(1,:),Traj3(2,:),Traj3(3,:))
B=CAIPIkI<(max(CAIPIkI)+min(CAIPIkI)/2);
Traj3X=Traj3;
Traj3X(:,B)=NaN;
figure;plot(Traj3X(1,:),Traj3X(2,:),'LineWidth',2);hold on
Traj3X=Traj3;
Traj3X(:,~B)=NaN;
plot(Traj3X(1,:),Traj3X(2,:),'LineWidth',2);
setXaxis([-1.1 1.1]*ceil(MaxK));
setYaxis([-1.1 1.1]*ceil(MaxK));

%%
gprint(get(gcf,'Number'),[mainP filesep 'Traj'],[]) 
close(gcf);
save([mainP filesep 'Traj.mat'],'BARTTrajMS');
disp('Saved traj fig');
%% Summary P2
SummaryStr.MaxK=MaxK;
SummaryStr.nTraj=nTraj;
SummaryStr.Acc=Acc;
SummaryStr.XResmm=XResmm;
SummaryStr.nSlices=nSlices;


fileName = ['Summary_' BaseFN(6:11) '.txt'];
gStruct2txt(SummaryStr,[mainP filesep fileName]);
disp('Saved summary txt');
%%
Trajm2=BARTTrajMS(1:2,1:end-2);
Sz128=[128 128];

[FesNUFTOp,st] = nuFTOperator(BART2Fes_NUFT_Idxs(Trajm2,Sz128),Sz128);
Kd=st.nufftStruct.Kd;
SN=st.nufftStruct.sn;
P=st.nufftStruct.p/sqrt(prod(Sz128));
% save('ForTFNUFT.mat','SN','Kd','P','A','NUbyFS3');
save([mainP filesep 'TrajForNUFT.mat'],'Trajm2','SN','Kd','P');
disp('Saved TrajForNUFT');
%%
% Traj=BARTTrajMS(1:2,1:end-2);
% save([ScanP BaseFN filesep 'Traj.mat'],'Traj');
%%
if(MB>1)
    SliOffset=0;
else
    SliOffset=nSlices/2;
end
SensB=load([RefFldMapP 'Sens.mat']);
SensB=SensB.SensB;
SnsSzB=gsize(SensB,1:2);

% B0_HzU=load([RefFldMapP 'B0_HzU.mat']);
% B0_HzU=B0_HzU.B0_HzU;
% B0Q=imresizeBySlices(B0_HzU,SnsSzB);

FirstEcho=load([RefFldMapP 'FirstEcho.mat']);
FirstEcho=FirstEcho.FirstEcho;

FirstEcho=gflip(FirstEcho(:,:,:,SliOffset+(1:nSlices)),1:2);
Mg=grmss(FirstEcho,3);

B0S=load([RefFldMapP 'B0S.mat']);
B0S=B0S.B0S;
disp('ok');

% load('CurStatus_Ben4MinASL_x.mat','SensB','B0Q','Mg'); ;
%%
% SensX=SensB(:,:,:,6+(1:12),:);
SensX=permute(SensB(:,:,:,SliOffset+(1:nSlices),:),[1 2 3 5 4]);
SensX=gflip(SensX,1:2);

% B0Q2=B0Q(:,:,6+(1:12));
B0Q2=B0S(:,:,SliOffset+(1:nSlices));
B0Q2=gflip(B0Q2,1:2);
disp('ok');
%%
% ADataIsP=double(permute(ADataIsL,[1 5 2 3 4]));
ADataIsPy=double(permute(ADataIsL(:,:,1:nSlicesNoMB,:,:),[1 5 2 3 4]));

nReps=size( ADataIsPy,5);
nChannels=size( ADataIsPy,3);

try
    dx=AData.hdr.Phoenix.sSliceArray.asSlice{1}.sPosition.dSag/AData.hdr.Phoenix.sSliceArray.asSlice{1}.dReadoutFOV;
catch
    disp('No x shift!');
    dx=0;
end

dx=RotatedLocs(2,1)/AData.hdr.Phoenix.sSliceArray.asSlice{1}.dReadoutFOV;

kx=BARTTrajMS(1,:)*2*pi;
ky=BARTTrajMS(2,:)*2*pi;

dy=RotatedLocs(1,1)/AData.hdr.Phoenix.sSliceArray.asSlice{1}.dPhaseFOV;
modx=double(exp(1i*(dx*kx+dy*ky))');

ADataIsPy=reshape(ADataIsPy,[paramLongROSamples,nChannels nSlicesNoMB nReps]);
if(OutInOut)
    ADataIsPy=PartitionDim(ADataIsPy,1,3);
    ADataIsPy=ADataIsPy(:,:,:,:,WhichE);
end
ADataIsPy=ADataIsPy(1:size(BARTTrajMS,2),:,:,:,:);

ADataIsPy=RepDotMult(ADataIsPy,modx);

AA=grmss(ADataIsPy,[2 3 4]);
% clear ADataIsPx ADataIsP ADataIx ADataIsL
disp('ok b')
%%
clear ADataIsP                  
clear ADataIsL                 
clear ADataIx       
clear ADataIsPx   
%%
% LAA=log(AA(600:4000,1));
% 
% Reg=1:size(LAA,1);
% Regs=[Reg.^3; Reg.^2; Reg; Reg*0+1];
% Coeffs=(LAA.')/(Regs);
% 
% LAAC=LAA-(Regs'*Coeffs');
% 
% cCAIPIVec=cumsum(CAIPIVec)*gamma*10*2*pi/1e6;
% cCAIPIVecX=interp1(1:numel(cCAIPIVec),cCAIPIVec,1:1/4:numel(cCAIPIVec));
% 
% Rndd=floor(numel(LAAC)/160)*160;
% 
% SToFit=LAAC(1:Rndd);
% CVecF=cCAIPIVecX(1:Rndd).';
% clear CC
% for i=1:200
%     C=corrcoef(circshift(CVecF,i-1,1),SToFit);
%     CC(i)=C(1,2);
% end
% [MaxCorr, MaxCorrI]=max(CC);
% 
% Sftd=circshift(cCAIPIVecX,MaxCorrI-1,1);
% 
% Reg=Sftd(1:numel(LAAC));
% Regs=[Reg; Reg*0+1];
% Coeffs=(LAAC.')/(Regs);
% SftdN=Sftd*Coeffs(1)+Coeffs(2);
% 
% figure;plot(LAAC);hold on;plot(SftdN(1:numel(LAAC)));
%%
SliI=6;
SliIs=[SliI SliI+nSlicesNoMB];
%%
nukData=ADataIsPy(:,:,SliI,1).';

nukData=nukData(:,3:end);
nTraj=size(nukData,2);
TimeInMs2=(0:nTraj-1)*2.5/1e3;
T2SCompStr='';
T2SEstMs=20;
T2SEstDecay=exp(-TimeInMs2/T2SEstMs);

Sz2=gsize(SensX,1:2);

BARTTrajAct=BARTTrajMS(:,1:size(nukData,2));
disp('ok');
%%
nukData=ADataIsPy(:,:,SliI,1).';
nukData=nukData(:,3:end);
% nukData=nukData.*T2SEstComp;
nukDataP=permute(nukData,[3 2 4 1]);

SensP=permute(SensX(:,:,:,:,SliI),[1 2 5 3 4]);

% %% MB
% nukDataP=nukDataP(:,:,1);
% SensP=ones(Sz2);
disp('ok');
%%
% setenv('TOOLBOX_PATH','~/HomeA/bart-0.4.03')
RecIfTVs=@(x) bart(['pics -S -m -R T:7:0:' num2str(x) ' -t'],BARTTrajAct, nukDataP, SensP(:,:,:,:,1));
RecIfWs=@(x) bart(['pics -S -m -R W:7:0:' num2str(x) ' -t'],BARTTrajAct, nukDataP, SensP(:,:,:,:,1));

RecIfTVsMM=@(x) bart(['pics -S -m -R T:7:0:' num2str(x) ' -t'],BARTTrajAct, nukDataP, SensP);
RecIfWsMM=@(x) bart(['pics -S -m -R W:7:0:' num2str(x) ' -t'],BARTTrajAct, nukDataP, SensP);
% ScrfTV=@(x) gScoreImageSimilarity(RecIfTV(x),ARefImg,RefDx,RefDy);

Lambda=1e-6;
% Rec=RecIfTVs(Lambda);
Rec=RecIfWs(Lambda);

RecMM=RecIfWsMM(Lambda);

fgmontage(cat(3,Rec,RecMM(:,:,1)));
xlabel(['BART No n0: Left - Single map, ADMM. Right - with 2 maps, Wavelet Lambda= ' num2str(Lambda)]);

% fgmontage(RecMM)
%
title(['BART No B0 W=' num2str(Lambda)]);
YLbl=['Sli' num2str(SliI,'%02d')];
ylabel(YLbl);
%%
gprint(get(gcf,'Number'),[mainP filesep YLbl '_BARTRecon_NoB0_W' num2str(Lambda) T2SCompStr],[]) 
close(gcf);
save([mainP filesep YLbl '_BARTRecon_NoB0_W' num2str(Lambda) T2SCompStr '.mat'],'Rec');
disp(['Saved ' [mainP filesep YLbl '_BARTRecon_NoB0_W' num2str(Lambda) T2SCompStr '.mat']]);
%% All timepoint
if(nReps>20)
    RecT=zeros([size(Rec) nSlices nReps]);
    RecIfWsD=@(x,D,SensP) bart(['pics -S -m -R W:7:0:' num2str(x) ' -t'],BARTTrajAct, D, SensP(:,:,:,:,1));
    for SliI=1:nSlices
        for r=1:nReps
            nukData=ADataIsPy(:,:,SliI,r).';
            nukData=nukData(:,3:end);
            % nukData=nukData.*T2SEstComp;
            nukDataP=permute(nukData,[3 2 4 1]);
            
            SensP=permute(SensX(:,:,:,:,SliI),[1 2 5 3 4]);
            
            RecBART(:,:,SliI,r)=RecIfWsD(Lambda,nukDataP,SensP);
            disp(['ok ' num2str(SliI) ' r' num2str(r)]);
        end
    end
    save([mainP filesep 'BARTRecon_NoB0_W' num2str(Lambda) T2SCompStr '.mat'],'RecBART');
end
% MCE=abs(mean(RecT(:,:,SliI,2:2:end),4));
% MCO=abs(mean(RecT(:,:,SliI,1:2:end),4));
% D=MCE-MCO;
% fgmontage(rot90(D),[0 7e-3])
% 
% fgmontage(abs(std(RecT(:,:,SliI,1:2:end),[],4)),[0 5e-5])
%%
figure;
subplot(2,2,1);
gmontage(Rec);title('BART recon');
ylabel(YLbl);

subplot(2,2,2);
gmontage(Mg(:,:,SliIs));title('FieldMap 1st echo mag');colorbar
subplot(2,2,3);
gmontage(SensX(:,:,:,1,SliIs));title('Fieldmap sens');colorbar
subplot(2,2,4);
gmontage(B0Q2(:,:,SliIs),[-300 300]);title('Fieldmap B0 Hz');colorbar
%%
gprint(get(gcf,'Number'),[mainP filesep YLbl '_Params'],[]) 
close(gcf);
disp(['printed fig to file' [mainP filesep YLbl '_Params']]);
%%
SliI=6;
SliIs=[SliI SliI+nSlicesNoMB];
%% All B0 effects across time
% Mgc=imresizeBySlices(gflip(Mg(:,:,SliI+6),1:2),Sz2);
% Mgc=imresizeBySlices(Mg(:,:,SliI+6),Sz2);
Mgc=imresizeBySlices(Mg(:,:,SliIs),Sz2);
Mskc=Mgc>7e-5;
MskcE=imdilate(imfillholesBySlices(Mskc),strel('disk',5,8));

% B0M2=-B0Q2(:,:,SliI);
% B0M2(~Mskc)=0;
% 
% SymMskC=abs(B0M2-gflip(B0M2,1))>230;
% SymMskC(1:30,:,:)=true;
% 
% B0M2(SymMskC & B0M2>150)=-20;
% fgmontage(B0M2)
% 
% cx=caxis
% fgmontage(X2,cx)
% 
% B0M2=X2;
B0M2=B0Q2(:,:,SliIs);

B0M2(~MskcE)=0;

% B0M2=-B0M2;
% B0M2(B0M2>150)=-20;
% fgmontage(B0M2)
disp('ok Loaded B0 from field map');
%%
% B0M2=B0RealEx;
[U_TimeInMs2, IA_TimeInMs2, IB_TimeInMs2]=unique(TimeInMs2);
nU_TimeInMs2=numel(U_TimeInMs2);
%%
clear TSB TSC
MaxCond=1e4;
for WhichB=1:2
    [TSBC{WhichB},TSCC{WhichB},nTSXC(WhichB),CondGHG]=GetTSCoeffsByMinMaxHist(B0M2(:,:,WhichB),TimeInMs2,500,MaxCond);
end
nTSX=max(nTSXC);
TSC=ones([gsize(B0M2,1:2) nTSX 2]);
TSB=zeros([nTraj nTSX 2]);
for WhichB=1:2
    TSC(:,:,1:nTSXC(WhichB),WhichB)=TSCC{WhichB};
    TSB(:,1:nTSXC(WhichB),WhichB)=TSBC{WhichB};
end
nTS=nTSX;
%%
ShowTFCoeffs=false;
if(ShowTFCoeffs)
    CLRs='rgbcmkrgbcmkrgbcmkrgbcmk';
    figure;
    for BandToShow=1:MB
        Step=gmax(abs(TSB))*2;
        for i=1:size(TSB,2)
            plot((1:nTraj)+BandToShow*nTraj*1.5,real(TSB(:,i,BandToShow)) + i*Step,CLRs(i));
            hold on
            plot((1:nTraj)+BandToShow*nTraj*1.5,imag(TSB(:,i,BandToShow)) + i*Step,[CLRs(i) '--']);
        end
    end
end
%%
SliI=6;
SliIs=[SliI SliI+nSlicesNoMB];


%TSB=TSBS(:,:,SliIs);
 %TSC=TSCS(:,:,:,SliIs);
%% GPU TS
cCAIPIVecX=interp1(1:numel(cCAIPIVec),cCAIPIVec,1:1/4:numel(cCAIPIVec));
cCAIPIVecY=cCAIPIVecX(3:end-1);
cCAIPIVecZ=exp(1i*cCAIPIVecY.*(RotatedLocs(3,SliIs)'));
osf = 2; % oversampling: 1.5 1.25
wg = 3; % kernel width: 5 7
sw = 8; % parallel sectors' width: 12 16

NTrg1=Sz2;
nBands=MB;
nShots=paramLongInterleaves;

TSBF=permute(TSB(IB_TimeInMs2,:,:),[2 1 3]);

Sens=squeeze(SensX(:,:,:,1,SliIs));

cCAIPIVecZMod=cCAIPIVecZ;

GOP_MCSMBMS = ggpuNUFT_TS_MC_MB_MS_CAIPI(BARTTrajAct,NTrg1,osf,wg,sw,TSBF,TSC,Sens,cCAIPIVecZMod);
GOP_MC=GOP_MCSMBMS;
nTrajP2=nU_TimeInMs2;
disp('ok');
%%
SliIP=[mainP filesep YLbl filesep];
mkdir(SliIP);
save([SliIP 'TSBF_TSC_Sens.mat'],'TSBF','TSC','Sens');
disp(['Saved ' SliIP 'TSBF_TSC_Sens.mat']);
%%
x = randn([Sz2 MB]) + 1j*randn([Sz2 MB]);
y = randn([size(Sens,3) nTrajP2]) + 1j*randn([size(Sens,3) nTrajP2]);
Ax = GOP_MC*x;
Aty = GOP_MC'*y;
Out=abs(x(:)'*Aty(:) - conj(y(:)'*Ax(:)))
if(abs(Out)>1e-3)
    disp('Operator error?');
end
%%
nukData=ADataIsPy(:,:,SliI,WhichRep).';
nukData=nukData(:,3:end);

DataP=nukData;
%%
% if(nShots==1)
    TVOP=TVOP_MSlice;
% else
%     TVOP=TVOP_MTC_W([1 1 0 1e1]);
% end
WhichReps=11;
% WhichReps=1:nReps;
for WhichRep=WhichReps
    disp(WhichRep);
    nukData=ADataIsPy(:,:,SliI,WhichRep).';
    nukData=nukData(:,3:end);
    
%     nukData=nukData.*exp(1i*B0ShiftRad4(1:size(nukData,2)));

            
    DataP=nukData;
    
    
    AOdd = GOP_MCSMBMS;
    
    TVW=1e-7;
    
    % filterType:   string, 'Haar', 'Beylkin', 'Coiflet', 'Daubechies','Symmlet', 'Vaidyanathan','Battle'
    % Use suffix _TI for translation invariance, for example, 'Daubechies_TI'
    % filterSize: related to the support and vanishing moments of the particular wavelet (See MakeONFilter in wavelab)
    % wavScale: 	scallest scale of wavelet decomposition
    
    XFMStr='Daubechies';
    
    filterSize=4;
    wavScale=4;
    
    if(strcmp(XFMStr,'None'))
        XFM=1;
        xfmWeight=0;
    else
        XFM = Wavelet(XFMStr,filterSize,wavScale);
        xfmWeight = 1e-7;	% Weight for Transform L1 penalty
    end
    
    
    param=ExtendStruct(struct('pNorm',1,'TVWeight',TVW,'Itnlim',8,'FT',AOdd,'Verbose',false,'XFM',XFM,'TV',TVOP,'xfmWeight',xfmWeight),init);
    
    % XFM=SubSpaceOp(V,SdT,1);
    % xfmWeight=1e-1;
    % % param=ExtendStruct(struct('pNorm',2,'TVWeight',TVW,'Itnlim',8,'FT',AOdd,'Verbose',false,'XFM',XFM,'TV',TVOP,'xfmWeight',xfmWeight),init);
    % % param=ExtendStruct(struct('pNorm',2,'TVWeight',0,'Itnlim',8,'FT',AOdd,'Verbose',false,'XFM',XFM,'TV',1,'xfmWeight',xfmWeight),init);
    % param=ExtendStruct(struct('pNorm',2,'TVWeight',0.01,'Itnlim',8,'FT',AOdd,'Verbose',false,'XFM',XFM,'TV',TVOP,'xfmWeight',xfmWeight),init);
    
    
    param.data =     DataP;
    
    param.ShowFig=false;
    
    nfnlCgIters=40;
    RunFnlViewAmp=1;
    res=zeros([Sz2 MB]);
    if(nShots>1)
        res=repmat(resA,[1 1 1 nShots]);
        res=res+randn(size(res))*max(abs(resA(:)))/20;
    end
    
    FigH=4000;
    if(param.ShowFig)
        figure(FigH);close(FigH);
    end
    
    if(~isfield(param,'ShowFig'))
        param.ShowFig=true;
    end
    StartTime_fnl=now;
    param.Verbose=false;
    clear ObjConv Score
    for n=1:nfnlCgIters
        [res, CurObj] = fnlCg(res,param);
        ObjConv(n)=CurObj;
        im_res = param.XFM'*res;
        if(param.ShowFig)
            figure(FigH); subplot(1,3,1);
            gmontage(abs(gflip(im_res,[]))); drawnow;% title(qq)
            cx=caxis;
            caxis(cx/RunFnlViewAmp);
            subplot(1,3,2);
            gmontage(angle(gflip(im_res,[]))); drawnow;% title(qq)
            subplot(1,3,3);
            plot(ObjConv);setYaxis([0 CurObj*3]);if(n>1), setXaxis([1 n]);end
            
        end
        if(n>1)
            dObjP=(ObjConv(n-1)-CurObj)/ObjConv(n-1);
            disp(['Iter #' num2str(n,'%02d') ' ' datestr(now) ' ' num2str(CurObj,'%5.3g') ' dObjP ' num2str(dObjP,'%g')]);
            if(dObjP<2e-3)
                disp('Not advancing. Stopping.');
                break;
            end
        else
            disp(['Iter #' num2str(n,'%02d') ' ' datestr(now) ' ' num2str(CurObj,'%5.3g')]);
        end
        
        if(nShots==1)
            resA=res;
        end
    end
    if(param.ShowFig)
        close(FigH);
    end
    disp('ok im_res');
    
    % ImResR(:,:,SliI,r)=im_res(:,:,1);
    % ImResR(:,:,SliI+nSlicesNoMB,r)=im_res(:,:,2);
    
    ImResR(:,:,SliIs,WhichRep)=im_res;
end
DefRange=[0 7e-3];
if(WhichE==2)
    DefRange=[0 3e-3];
end
fgmontage(im_res,DefRange);
%%
fgmontage(im_res,DefRange);

XFMStrFull=['[' XFMStr ',' num2str(filterSize) ',' num2str(wavScale) ',' num2str(xfmWeight) ']'];
XLbl=['L' num2str(param.pNorm) ',TVW=' num2str(param.TVWeight) ',' XFMStrFull ];
xlabel(XLbl)
YLbl=['Sli' num2str(SliI,'%02d')];
ylabel(YLbl);
%%
gprint(get(gcf,'Number'),[mainP filesep YLbl '_' XLbl T2SCompStr],[]) 
close(gcf);
save([mainP filesep YLbl '_' XLbl T2SCompStr '.mat'],'im_res');
disp(['Saved' mainP filesep YLbl '_' XLbl T2SCompStr '.mat']);
%%
DataP2=double(permute(DataP,[3 2 1]));

nukData=ADataIsPy(:,:,SliI,1).';
nukData=nukData(:,3:end);
%%
[U,S,sccmtx] = svd(nukData.','econ');
ncc=16; % Maybe need more for MB?

% nMapsToUse=size(SensX,4);
nMapsToUse=1;

CurSens=SensX(:,:,:,1:nMapsToUse,SliIs);

SensCC=permute(MultMatTensor(sccmtx(:,1:ncc).',permute(CurSens,[3 1 2 4 5])),[2 3 1 4 5]);

DataCC=(sccmtx(:,1:ncc).'*nukData);
DataPCC=double(permute(DataCC,[3 2 1]));
disp('Applied coil compression to this slice(s)');
%% Clean save
% BaseOutLoc='/media/a/DATA/';
SensMsk=single(grmss(SensCC(:,:,:),3)>0.01);

SensCCA=SensCC(:,:,:,1,1);
SensCCB=SensCC(:,:,:,1,2);
SensMskA=single(grmss(SensCCA(:,:,:),3)>0.01);
SensMskB=single(grmss(SensCCB(:,:,:),3)>0.01);

TSBFA=TSBF(:,:,1).*cCAIPIVecZ(1,:);
TSBFB=TSBF(:,:,2).*cCAIPIVecZ(2,:);
TSCA=TSC(:,:,:,1);
TSCB=TSC(:,:,:,2);

CurOurP=[mainP filesep];
mkdir(CurOurP);
CurOurPSli=[mainP filesep 'Sli' num2str(SliI,'%02d') filesep];
mkdir(CurOurPSli);
save([CurOurPSli 'Sens.mat'],'CurSens');
save([CurOurPSli 'SensCC.mat'],'SensCC','sccmtx','SensMsk');
save([CurOurPSli 'SensCC1.mat'],'SensCCA','SensCCB','sccmtx','SensMskA','SensMskB');
save([CurOurPSli 'B0TS.mat'],'TSBFA','TSBFB','TSB','TSCA','TSCB','osf','wg','sw','Mgc','TimeInMs2');
save([CurOurPSli 'TrajAndRealData.mat'],'BARTTrajAct','DataP2','DataPCC');
disp('Saved');
%%
tmp=squeeze(DataPCC);
% RealDataFac=grmss(AllData(5656:34:6767,:,:))/grmss(tmp)
RealDataFac=100;
CurIDataV=Row(tmp)*RealDataFac;
CurIDataVR=[real(CurIDataV) imag(CurIDataV)];

BatchSizeInNN=6;
Data=repmat(single(CurIDataVR),[BatchSizeInNN 1]);
if(WhichE==2)
    Data=Data*2.5;
end
RealDataFN=[CurOurPSli 'RealDataForNN.mat'];
save(RealDataFN,'Data');
disp('Saved real data');
%% At this point ready for TF
%% Call TF
% pause(60*60*11);
CurOurPSli=[mainP filesep 'Sli' num2str(SliI,'%02d') filesep];

%ParamsSDefaults=getParamsStructFromFN('/media/a/H2/home/a/TF/srez/RegridTry3C2_7TS_XXX_Sli06__2018-09-20_13-34-00_train/');
% ParamsSDefaults=getParamsStructFromFN('/media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/TF/srez/RegridTry3C2_7TS_RL_S3__2018-07-16_15-19-07_train/');
ParamsSDefaults=getParamsStructFromFN('/home/deni/TF/srez/RegridTry3C2_7TS_S02_Sli01__2018-07-23_09-40-59_train/');
ParamsS=ParamsSDefaults;
ParamsS.SessionNameBase=['RegridTry3C2_7TS_' MIDStr '_Sli' num2str(SliI,'%02d')];

ParamsS.RealDataFN=[CurOurPSli 'RealDataForNN.mat'];
ParamsS.BaseTSDataP=CurOurPSli;
ParamsS.BaseNUFTDataP=[mainP filesep];

ParamsS.DatasetMatFN='/home/deni/HCPData_256x256_int16.mat';
%ParamsS.DatasetMatFN='/media/a/H1/HCPData_256x256_int16.mat';
ParamsS.nToLoad=10000;

% Parames for MB:
ParamsS.nccInData=ncc;
ParamsS.InputMode='RegridTry3FMB';
ParamsS.NetMode='RegridTry3C2_TS_MB';

% To change and decide
ParamsS.nccToUse=16;    %13
ParamsS.nNeighbors=12;  %12
ParamsS.nTimeSegments=9; %11

ParamsS.batch_size=BatchSizeInNN;
ParamsS.WL2_Lambda=0;

ParamsS.RandomPhaseLinearFac=3;
ParamsS.RandomPhaseQuadraticFac=0.05;
ParamsS.RandomPhaseScaleFac=2;

ParamsS.checkpoint_period=20;

ParamsS.InitForRFN='None';
ParamsS.InitForLFN='None';

%ParamsS=getParamsStructFromFN([LastP filesep]);
ParamsS.learning_rate_start=0.003;
ParamsS.learning_rate_half_life=30;
ParamsS.train_time=240;

ParamsS.nToLoad=10000;

%ParamsS.InitForLFN=LastFN;
%ParamsS.InitForRFN=LastFN;

ParamsS.InitForRFN='None';
ParamsS.InitForLFN='None';
 %ParamsS.InitForRFN='/home/deni/TF/srez/RegridTry3C2_7TS_MID543_Sli06__2018-09-25_13-32-53_train/TrainSummary_023584.mat';

%ParamsS.batch_size=12;

ParamsS.BankSize=0; % Not use a signal bank
ParamsS.BankSize=1440;
ParamsS.BankK=7;

ParamsS.ShowRealData=1;
ParamsS.DataH=size(Data,2);

% ParamsS.DataH=size(Data,2);

Txt=gStruct2txt(ParamsS,'~/TF/Params.txt');
% Txt=gStruct2txt(ParamsS,'~/TF/Params.txt');

CImages_b=ParamsS.nToLoad*256*256*2;
Reg_batch_b=128*128*ParamsS.nNeighbors*ParamsS.nccToUse*4*2*ParamsS.batch_size;
Kside_b=ParamsS.batch_size*128*128*ParamsS.nNeighbors*ParamsS.nccToUse*ParamsS.nTimeSegments*2*4*2;
SBank_b=ParamsS.DataH*4*ParamsS.BankSize*2;
IBank_b=128*128*4*2*ParamsS.BankSize*2;
Ttl_b=CImages_b+Reg_batch_b+Kside_b+SBank_b+IBank_b;
disp(['Constant images: ' num2str(CImages_b/1e9,'%.2f') 'GB']);
disp(['Regridded batch data ' num2str(Reg_batch_b/1e6,'%.2f') 'MB']);
disp(['Kside ' num2str(Kside_b/1e9,'%.2f') 'GB']);
disp(['Signal Bank ' num2str(SBank_b/1e9,'%.2f') 'GB']);
disp(['Image Bank ' num2str(IBank_b/1e6,'%.2f') 'MB']);
disp(['Total ' num2str(Ttl_b/1e9,'%.2f') 'GB']);
disp(['Bank batches: ' num2str(ParamsS.BankSize/ParamsS.batch_size)]);
%
%system('sudo -H -u a /media/a/H2/home/a/RunTFForMatlabx.sh');
%     system('sudo -H -u a /media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
 system('sudo /home/deni/RunTFForMatlabx.sh');
% /home/deni/TF/srez/RegridTry3C2_7TS_g18_Sli06__2018-08-16_12-35-57_train
% gSendMail('Subject',Txt,Image FileName,EmailAddr)
%% Look at the convergence graph
LastTrainedNet=[TFFolder FindNewestFolderWithPrefix(TFFolder,'Re','_train')];
GraphOptFromFolderf(LastTrainedNet,true);
%% Look at the image-side segments combination coefficient maps
W=getWeightsOfNetC(LastTrainedNet);
WIm=reshape(W.gene_GEN_L010_PixelwiseMultC_weightC,128,128,2,[]);
%%
TrainedNetP=[TFFolder FindNewestFolderWithPrefix(TFFolder,'Re','_check')];
TrainedNetPT=[TrainedNetP(1:end-10) 'train' filesep];
UsedParams=getParamsStructFromFN(TrainedNetPT);
%%

LastP=[TFFolder FindNewestFolderWithPrefix(TFFolder,'Re','_train')];
[~, LastFN]=FindNewestFileWithPrefix(LastP,'Tra','mat');

[~, LastPNG]=FindNewestFileWithPrefix(LastP,'b','png');
NNres=double(imread(LastPNG));
NNres=reshape(NNres(1:128,256*5+(1:256),1),[128 128 MB]);

BartResN=A.RecTSAllX(:,:,[6 18],11);
BartResN=BartResN*grmss(NNres)/grmss(BartResN);
%% Run on all repetitions (save all repetitions' data before)

% The network before trained and is on the following folder:
TrainedNetP='/home/deni/TF/srez/RegridTry3C2_7TS_MID448_Sli06__2018-09-20_09-17-39_checkpoint';
St=ParamsS;
St.LoadAndRunOnData=1;
St.LoadAndRunOnData_checkpointP=TrainedNetP;
St.LoadAndRunOnData_Prefix=[mainP filesep 'RealData' filesep 'Sli' num2str(SliI) '_r'];
St.LoadAndRunOnData_OutP=[mainP filesep 'RealDataOut' filesep 'Sli' num2str(SliI,'%02d') filesep];

St.HowManyToRun=100;
Txt=gStruct2txt(St,'~/TF/Params.txt');

system('sudo /home/deni/RunTFForMatlabx.sh');

    % disp('Prepared Params');
    %
%     system('sudo -H -u a /media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
%     system('sudo /home/deni/RunTFForMatlabx.sh');
% end
%% Read NN output all reps
% NNOutP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/meas_MID488_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_4min_FID26056/RealDataOut/Sli06/';
NNOutP=St.LoadAndRunOnData_OutP;
D=dir([NNOutP '*.mat']);
for r=1:numel(D)
    tmp=load([NNOutP D(r).name]);
    NNRec(:,:,r)=double(squeeze(tmp.x(1,:,:,1))+1i*squeeze(tmp.x(1,:,:,2)));
end
disp('ok')
%%
MEven=NNRec(:,:,2:2:end);
MOdd=NNRec(:,:,1:2:end);
Perf=abs(MEven)-abs(MOdd);
MPerf=mean(Perf,3);
SPerf=std(Perf,0,3);
tSNR_Perf=MPerf./SPerf;

TMsk1=tSNR_Perf>0.3;
TMsk1(:,[1:10 50:138 188:256])=0;
TwoD=Reshape4d22d(permute(Perf,[1 2 4 3]),TMsk1);
%%
%% SensCCS for all slices
WhichSlices=nSlicesNoMB:-1:1;
for SliI=WhichSlices
    SliIs=[SliI SliI+nSlicesNoMB];

    nukData=ADataIsPy(:,:,SliI,min(25,size(ADataIsPy,4)-1)).';
    nukData=nukData(:,3:end);

    [U,S,sccmtx] = svd(nukData.','econ');
    
    sccmtxS(:,:,SliI)=sccmtx;
    
    ncc=16;

    for b=1:nBands
        CurSens=SensX(:,:,:,1,SliIs(b));
        SensCC=permute(MultMatTensor(sccmtx(:,1:ncc).',permute(CurSens,[3 1 2 4])),[2 3 1 4]);
        SensCCS(:,:,:,:,SliIs(b))=SensCC;
    end
end
disp('SensCCS ok');
%% All B0 effects across time
MgF=imresizeBySlices(Mg,Sz2);
MskcF=MgF>7e-5;
MskcEF=imdilate(imfillholesBySlices(MskcF),strel('disk',5,8));
B0MF=B0Q2;
B0MF(~MskcEF)=0;
% fgmontage(B0MF,[-500 500])
disp('ok Loaded B0 from field map, all slices');
%% TS for all slices
clear TSBC TSCC
MaxCond=1e4;
for WhichB=1:nSlices
    [TSBC{WhichB},TSCC{WhichB},nTSXC(WhichB),CondGHG]=GetTSCoeffsByMinMaxHist(B0MF(:,:,WhichB),TimeInMs2,500,MaxCond);
end
nTSX=max(nTSXC);
TSC=ones([gsize(B0M2,1:2) nTSX 2]);
TSB=zeros([nTraj nTSX 2]);
clear TSCS TSBS
for WhichB=1:nSlices
    TSCS(:,:,1:nTSXC(WhichB),WhichB)=TSCC{WhichB};
    TSBS(:,1:nTSXC(WhichB),WhichB)=TSBC{WhichB};
end
nTS=nTSX;
disp('ran GetTSCoeffsByMinMaxHist on all')
%%
RecTSAll=NaN([gsize(SensCC,1:2) MB nSlicesNoMB nReps]);
%% BART TS try: To do after having coil compression matrices, B0 correction matrices for all slices
setenv('TOOLBOX_PATH','~/bart-0.4.03TS')
% setenv('TOOLBOX_PATH','~/HomeA/bart-0.4.03TS')

% WhichRepToRun=25;
WhichRepToRun=1:nReps;

% WhichSliIsToRun=3;
WhichSliIsToRun=1:nSlicesNoMB;

for RepToRun=WhichRepToRun    
    for SliI=WhichSliIsToRun
        SliIs=[SliI SliI+nSlicesNoMB];
        disp([RepToRun SliIs]);
        nukData=ADataIsPy(:,:,SliI,RepToRun).';
        nukData=nukData(:,3:end);

        sccmtxBoth = sccmtxS(:,:,SliI);
        nScc=16;
        SensFCCBoth=squeeze(SensCCS(:,:,:,:,SliIs));
        
        DataCC=CC(permute(nukData,[3 2 1]),sccmtxBoth(:,1:nScc));
        nukDataP=permute(DataCC,[3 1 4 2]);
        
        nBands=MB;
        TSBFA=permute(TSBS(:,:,SliIs),[4 1 6 5 3 2]);
        TSBFAm=repmat(TSBFA,[1 1 1 nScc 1 1 1 1 1]);
        cCAIPIVecZ_CurSlis=exp(1i*cCAIPIVecY.*(RotatedLocs(3,SliIs)'));
        TSBFAm=TSBFAm.*permute(cCAIPIVecZ_CurSlis,[3 2 4 5 1 6]);
        
        TSBFm=TSBFAm;
        TSBFm=TSBFm/nTS;
        writecfl('/tmp/TSB',TSBFm);
        
        TSCToUse=TSCS(:,:,:,SliIs);        
        SensP=permute(SensFCCBoth,[1 2 5 3 4]);
        SensW=SensP.*permute(TSCToUse(:,:,:,:),[1 2 5 6 4 3])*nTS;
        if(WhichE==2)
            SensW=SensW.*permute(exp(1i*2*pi*B0MF(:,:,SliIs)*TimeInMs2(end)/1000),[1 2 4 5 3 6]);
        end
        TrajW=repmat(BARTTrajAct,[1 1 1 nScc 2 nTS]);
        
        disp(datestr(now));
        RecTS=bart(['pics -S -m -R W:7:0:' num2str(1e-7) ' -t'],TrajW, nukDataP, SensW);
%         RecTS=bart(['pics -S -m -R T:3:3:' num2str(1e-8) ' -t'],TrajW, nukDataP, SensW);
        disp(datestr(now));
        RecTSAll(:,:,:,SliI,RepToRun)=RecTS;
    end
end
save([mainP filesep 'RecTSAll.mat'],'RecTSAll');
fgmontage(RecTS);title('BART TS')
%%
RecTSAllX=CombineDims(RecTSAll,[3 4]);
save([mainP filesep 'RecTSAllX.mat'],'RecTSAllX');
%% End BART TS Try














%%
% pause(60*60*11);
for SliI=WhichSlices
    CurOurPSli=[mainP filesep 'Sli' num2str(SliI,'%02d') filesep];

    ParamsSDefaults=getParamsStructFromFN('/media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/TF/srez/RegridTry3C2_7TS_RL_S3__2018-07-16_15-19-07_train/');
    ParamsS=ParamsSDefaults;
    ParamsS.SessionNameBase=['RegridTry3C2_7TS_' ScanP(end-3:end-1) '_Sli' num2str(SliI,'%02d')];
    ParamsS.RealDataFN=[CurOurPSli 'RealDataForNN.mat'];
    ParamsS.BaseTSDataP=CurOurPSli;
    ParamsS.BaseNUFTDataP=[mainP filesep];
    Txt=gStruct2txt(ParamsS,'~/HomeA/TF/Params.txt');
    
    system('sudo -H -u a /media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
end

%% ESPIRIT
GOP2=gpuNUFFT(BART2Fes_NUFT_Idxs(BARTTrajAct,Sz2)'/(2*pi),ones(nTrajP2,1),osf,wg,sw,Sz2,double(TSC));
GOP_TS=ggpuNUFT_TS(GOP2,double(TSBF));
GOP_TS_ESP=ggpuNUFT_TS_MCnosum(GOP_TS,[1 1 32]);

CurSens=SensX(:,:,:,:,SliI);
weights=ones(gsize(CurSens,[1 2 4]));
ESP = ESPIRiT(CurSens,weights);

DataP2=double(permute(DataP,[3 2 1]));
disp('ok');
%%
XOP = Wavelet('Daubechies_TI',4,6);

splitWeight=0.5;
lam=1e-6;
% nIterSplit=15;
% [resL1ESPIRiT] = cgL1ESPIRiT(DataP2, im_res*0, GOP_TS_ESP, ESP, 5,XFM,lam,splitWeight,nIterSplit);
% [resL1ESPIRiT] = cgL1ESPIRiT(DataP2, weights*0, GOP_TS_ESP, ESP, 5,XOP,lam,splitWeight,nIterSplit);
% This works but we skiup and go directly to CC
% [resL1ESPIRiT] = cgL1ESPIRiT(DataP2, weights*0, GOP_TS_ESP, ESP, 5,XOP,lam,splitWeight,2e-3);
disp('ok cgL1ESPIRiT');
%%
% save('CurStatusForL1ESPIRIT_MM_Ben4Min.mat')
%%
% resL1ESPIRiT1=resL1ESPIRiT(:,:,1);
% fgmontage(resL1ESPIRiT1,[0 7e-3])
% title('resL1ESPIRiT 2 maps, B0');
% ylabel(YLbl);
% xlabel(['Daubechies_TI lam ' num2str(lam) ' splitWeight ' num2str(splitWeight)]);
% 
% gprint(get(gcf,'Number'),[ScanP BaseFN filesep YLbl '_L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr ],[]) 
% close(gcf);
% save([ScanP BaseFN filesep YLbl '_L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '.mat'],'resL1ESPIRiT1');
% disp(['Saved ' ScanP BaseFN filesep YLbl '_L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '.mat']);
%%
weights=ones(gsize(CurSens,[1 2 4]));
ESP = ESPIRiT(CurSens,weights);

weightsCC=ones(gsize(CurSens,[1 2 4]));
ESPCC = ESPIRiT(SensCC,weightsCC);

GOP_TS_ESPCC=ggpuNUFT_TS_MCnosum(GOP_TS,[1 1 ncc]);

% GOP_MC_CC = ggpuNUFT_TS_MCx(BARTTrajAct,Sz2,osf,wg,sw,TSB.',TSC,SensCC(:,:,:,1));


    
DataCC=(sccmtx(:,1:ncc).'*nukData);

DataPCC=double(permute(DataCC,[3 2 1]));

XOP = Wavelet('Daubechies_TI',4,6);

splitWeight=0.5;
lam=1e-7;
nIterSplit=2e-3;
% nIterSplit=15;
% [resL1ESPIRiT] = cgL1ESPIRiT(DataP2, im_res*0, GOP_TS_ESP, ESP, 5,XFM,lam,splitWeight,nIterSplit);
[resL1ESPIRiTCC] = cgL1ESPIRiT(DataPCC, weightsCC*0, GOP_TS_ESPCC, ESPCC, 5,XOP,lam,splitWeight,nIterSplit);

disp('ok cgL1ESPIRiTCC');
%%
resL1ESPIRiTCC1=resL1ESPIRiTCC(:,:,1);
% fgmontage(cat(3,resL1ESPIRiT1, resL1ESPIRiTCC1),[0 7e-3])
% title(['resL1ESPIRiT 2 maps, B0. Right - with CC -> ' num2str(ncc)]);
fgmontage(resL1ESPIRiTCC1,[0 7e-3])
title(['resL1ESPIRiT ' num2str(nMapsToUse) ' maps, B0  with CC -> ' num2str(ncc)]);
ylabel(YLbl);
xlabel(['Daubechies_TI lam ' num2str(lam) ' splitWeight ' num2str(splitWeight)]);
%%
gprint(get(gcf,'Number'),[mainP filesep YLbl '_L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC' num2str(ncc)],[]) 
close(gcf);
save([mainP filesep YLbl '_L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC.mat'],'resL1ESPIRiTCC1');
disp(['Saved ' mainP filesep YLbl '_L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC.mat']);
%%
CurBartTraj=BARTTrajAct;
% CurBartTraj=BARTTrajMS;
nTraj=size(CurBartTraj,2);
% figure;plot(CurBartTraj(1,:),CurBartTraj(2,:),'.');
kMax=ceil(max(max(abs(CurBartTraj),[],2)));
% xlabel(nTraj);
Acc=(kMax*2)^2/nTraj;
% title(['kMax: ' num2str(kMax) ' Acc (for kMax): ' num2str(Acc)]);
%%
% % TBaseP='~/HomeA/TF/srez/';
% TBaseP='/media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/TF/srez/';
% 
% DataH=size(NMap,1);
% DataW=size(NMap,2);
% DataCh=size(NMap,3)*nChToUseInNN*2;
% LabelsH=Sz2(1);
% LabelsW=Sz2(2);
% LabelsCh=2;
% 
% ParamsSDefaults=struct('DataH',DataH,'DataW',DataW,'channelsIn',DataCh,'LabelsH',LabelsH,'LabelsW',LabelsW,'channelsOut',LabelsCh,...
%   'dataset',TFDataP,'learning_rate_start',0.002,...
%   'learning_rate_half_life',30,... % in minutes if <1000
%   'summary_period',0.5,'checkpoint_period',20,...
%   'MapSize',3,'train_time',120,'batch_size',16,'NumFeatPerChannel',2,'NumTotalFeat',64,...
%   'WL1_Lambda',0,'WL2_Lambda',0,...
%   'QuickFailureTimeM',3,'QuickFailureThresh',0.3,'DiscStartMinute',500,...
%   'ShowRealData',1,'CmplxBias',0,...
%   'InputMode','RegridTry1',...
%   'NetMode','RegridTry1C2_TS',...
%   'SessionNameBase','RegridTry1C2_TS',...
%   'ImgMode','Cmplx',...
%   'nTimeSegments',7,...
%   'UseSharedWightesInRelaxedFT',1,...
%   'WPhaseOnly',0.001,...
%   'NMAP_FN',NMapFN,...
%   'RealDataFN',RealDataFN);
% 
% ParamsS=ParamsSDefaults;
% Txt=gStruct2txt(ParamsS,'~/HomeA/TF/Params.txt');
% %%
% ParamsS=ParamsSDefaults;
% ParamsS.WPhaseOnly=0.01;
% ParamsS.train_time=120;
% Txt=gStruct2txt(ParamsS,'~/HomeA/TF/Params.txt');
% system('/media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
% 
% system('sudo bash -c ''echo "I am $USER, with uid $UID"''')
% system('sudo -H -u a bash -c ''echo "I am $USER, with uid $UID"''')
% 
% sendTFMail(TBaseP,ParamsS,Txt);
% %%
% ParamsS=ParamsSDefaults;
% ParamsS.MapSize=5;
% ParamsS.train_time=120;
% ParamsS.dataset='dataFaceP4C';
% ParamsS.learning_rate_start=0.001;
% ParamsS.learning_rate_half_life=60;
% ParamsS.WL1_Lambda=0;
% ParamsS.WL2_Lambda=0;
% Txt=gStruct2txt(ParamsS,'/home/a/TF/Params.txt');
% system('/home/a/RunTFForMatlab.sh');
% sendTFMail(TBaseP,ParamsS,Txt);









%% Now Multislice, mostly ok
WhichSlices=nSlicesNoMB:-1:1
%%
for SliI=WhichSlices
    CurOurPSli=[mainP filesep 'Sli' num2str(SliI,'%02d') filesep];
    mkdir(CurOurPSli);
    
    nukData=ADataIsPy(:,:,SliI,1).';
    nukData=nukData(:,3:end);
    
    DataCC=(sccmtxS(:,1:ncc,SliI).'*nukData);
    
    DataPCC=double(permute(DataCC,[3 2 1]));
    
    tmp=squeeze(DataPCC);
%     RealDataFacS(SliI)=grmss(AllData(5656:34:6767,:,:))/grmss(tmp);
    CurIDataV=Row(tmp)*100; %*RealDataFacS(SliI); % Change by Echo! WhichE
    CurIDataVR=[real(CurIDataV) imag(CurIDataV)];
    
    Data=repmat(single(CurIDataVR),[12 1]);
    RealDataFN=[CurOurPSli 'RealDataForNN.mat'];
    save(RealDataFN,'Data');
end
disp('Save slices real data for NN');
% save([BaseOutLoc BaseFN filesep 'RealDataFacS.mat'],'RealDataFacS');
%% All reps
CurRealDataP=[mainP filesep 'RealData' filesep];
mkdir(CurRealDataP);
for SliI=WhichSlices
    for r=1:nReps
        disp([SliI r]);
        nukData=ADataIsPy(:,:,SliI,r).';
        nukData=nukData(:,3:end);
        nukDataCC=MultMatTensor(sccmtxS(:,1:ncc,SliI).',nukData);
        
        CurIDataV=Row(nukDataCC.')*200; % *RealDataFac;
        CurIDataVR=[real(CurIDataV) imag(CurIDataV)];
        
        Data=repmat(single(CurIDataVR),[12 1]);
        RealDataFN=[CurRealDataP 'Sli' num2str(SliI) '_r' num2str(r,'%02d') '.mat'];
        %     RealDataFN=['/media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/TF/srez/RealData/b_Ben14May_Sli5_r' num2str(r,'%02d') '.mat'];
        save(RealDataFN,'Data');
    end
end
disp('Saved slices real data for NN all reps');

CurRealDataOutP=[mainP filesep 'RealDataOut' filesep];
mkdir(CurRealDataOutP);
for SliI=WhichSlices
    mkdir([CurRealDataOutP 'Sli' num2str(SliI,'%02d')]);
end
%%
MgcS=imresizeBySlices(Mg,Sz2);
MskcS=MgcS>7e-5;

MskcSE=imdilate(imfillholesBySlices(MskcS),strel('disk',5,8));
B0M2S=B0Q2;
B0M2S(~MskcSE)=0;

WhichSlices=nSlices:-1:1;
%%
clear TSBS TSCS
%%
nTS=11;
for SliI=WhichSlices
    B0M2=B0M2S(:,:,SliI);
    Mgc=MgcS(:,:,SliI);
    
    Mskc=Mgc>7e-5;
    MskcE=imdilate(imfill(Mskc,'holes'),strel('disk',5,8));
    B0M2(~MskcE)=0;
    
    AllB0C=exp(1i*2*pi*RepDotMult(B0M2,gpermute(TimeInMs2(IA_TimeInMs2)/1000,[3 2])));  % exp(1i*2*pi*(TimeInMs2/1000)*B0M2);
    E=reshape(AllB0C,prod(Sz2),nU_TimeInMs2);
    MgcN=Mgc./grmss(Mgc);
    WE=Col(MgcN);
    % WE=Col(MgcN)*0+1;
    WeightedE=WE.*E;
    
    % Fessler time segmentation
    clear ErrTS
    TS_Thresh=1e-5;
        FesTimePoints=linspace(0,TimeInMs2(end)/1000,nTS);
        TSC=exp(1i*2*pi*RepDotMult(B0M2,gpermute(FesTimePoints,[3 2])));  % exp(1i*2*pi*(TimeInMs2/1000)*B0M2);
        TSC2=reshape(TSC,prod(Sz2),nTS);
        WTSC2=WE.*TSC2;
        TSB=(WeightedE.')/(WTSC2.');% W in both sides

        CurErrTS=grmss(WeightedE-WTSC2*(TSB.')); %include W
        ErrTSS(nTS,SliI)=CurErrTS;

        disp([datestr(now) ' Sli #' num2str(SliI) ' nTS ' num2str(nTS) ' err=' num2str(CurErrTS)]);
    TSBS(:,:,SliI)=TSB;
    TSCS(:,:,:,SliI)=TSC;
end
disp('ok TSBS TSCS');
%%
% load([ScanP BaseFN filesep 'TSBS_TSCS.mat'])
save([mainP filesep 'TSBS_TSCS.mat'],'TSBS','TSCS','ErrTSS');
disp('Saved TSBS TSCS');
%%





%% save TSBF TSC Per slice
for SliI=WhichSlices
    YLbl=['Sli' num2str(SliI,'%02d')];
    
    SliIP=[mainP filesep YLbl filesep];
    mkdir(SliIP);
    
    TSB=squeeze(TSBS(:,:,SliI));
    TSC=squeeze(TSCS(:,:,:,SliI));
    TSBF=TSB(IB_TimeInMs2,:).';
    Sens=squeeze(SensX(:,:,:,1,SliI));
    
    save([SliIP 'TSBF_TSC_Sens.mat'],'TSBF','TSC','Sens');
    disp(['Saved ' SliIP 'TSBF_TSC_Sens.mat']);
end
%% Clean save per slice
% BaseOutLoc='/media/a/DATA/';
for SliI=WhichSlices
    SensCC=squeeze(SensCCS(:,:,:,:,SliI));
    SensMsk=single(grmss(SensCC(:,:,:),3)>0.01);
    CurOurP=[mainP filesep];
    CurOurPSli=[mainP filesep 'Sli' num2str(SliI,'%02d') filesep];
%     save([CurOurPSli 'Sens.mat'],'CurSens');
    save([CurOurPSli 'SensCC.mat'],'SensCC','sccmtx','SensMsk');
    SensCC=squeeze(SensCC(:,:,:,1));
    save([CurOurPSli 'SensCC1.mat'],'SensCC','sccmtx','SensMsk');
    
    TSB=squeeze(TSBS(:,:,SliI));
    TSC=squeeze(TSCS(:,:,:,SliI));
    TSBF=TSB(IB_TimeInMs2,:).';
    Mgc=MgcS(:,:,SliI);

    save([CurOurPSli 'B0TS.mat'],'TSBF','TSB','TSC','osf','wg','sw','Mgc','TimeInMs2');
    disp(['Saved ' num2str(SliI)]);
end
%% Call TF
% pause(60*60*11);
for SliI=WhichSlices
    CurOurPSli=[ScanP BaseFN filesep 'Sli' num2str(SliI,'%02d') filesep];

%     ParamsSDefaults=getParamsStructFromFN('/media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/TF/srez/RegridTry3C2_7TS_RL_S3__2018-07-16_15-19-07_train/');
    ParamsSDefaults=getParamsStructFromFN('/home/deni/TF/srez/RegridTry3C2_7TS_S02_Sli01__2018-07-23_09-40-59_train/');
    ParamsS=ParamsSDefaults;
    ParamsS.SessionNameBase=['RegridTry3C2_7TS_' ScanP(end-3:end-1) '_Sli' num2str(SliI,'%02d')];
    ParamsS.SessionNameBase=['RegridTry3C2_7TS_' MIDStr '_Sli' num2str(SliI,'%02d')];
    
    ParamsS.RealDataFN=[CurOurPSli 'RealDataForNN.mat'];
    ParamsS.BaseTSDataP=CurOurPSli;
    ParamsS.BaseNUFTDataP=[ScanP BaseFN filesep];
%     Txt=gStruct2txt(ParamsS,'~/HomeA/TF/Params.txt');
    Txt=gStruct2txt(ParamsS,'~/TF/Params.txt');
    
%     system('sudo -H -u a /media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
    system('sudo /home/deni/RunTFForMatlabx.sh');
end
% /home/deni/TF/srez/RegridTry3C2_7TS_g18_Sli06__2018-08-16_12-35-57_train
%% GPU TS
for SliI=WhichSlices
    TSBF=squeeze(TSBS(IB_TimeInMs2,:,SliI)).';
    Sens=squeeze(SensX(:,:,:,1,SliI));
    
    GOP_MCSMBMSS{SliI} = ggpuNUFT_TS_MC_MB_MS(BARTTrajAct,NTrg1,osf,wg,sw,TSBF,TSCS(:,:,:,SliI),Sens);
    GOP_MCS{SliI}=GOP_MCSMBMSS{SliI};
end
disp('ok');
%%
nfnlCgIters=40;
RunFnlViewAmp=1;

TVW=1e-6;

XFMStr='Daubechies';
filterSize=4;
wavScale=4;

FigH=4000;
    figure(FigH);clf;
    
for SliI=WhichSlices
    disp(SliI);
    nukData=ADataIsPy(:,:,SliI,1).';
    nukData=nukData(:,3:end);
    % nukData=nukData.*T2SEstComp;
    
    DataP=nukData;

    AOdd = GOP_MCSMBMSS{SliI};
    % AOdd = GOP_MC;


    if(strcmp(XFMStr,'None'))
        XFM=1;
        xfmWeight=0;
    else
        XFM = Wavelet(XFMStr,filterSize,wavScale);
        xfmWeight = 1e-6;	% Weight for Transform L1 penalty
    end


    param=ExtendStruct(struct('pNorm',1,'TVWeight',TVW,'Itnlim',8,'FT',AOdd,'Verbose',false,'XFM',XFM,'TV',TVOP,'xfmWeight',xfmWeight),init);

    param.data =     DataP;

    res=zeros(Sz2);
    if(nShots>1)
        res=repmat(resA,[1 1 1 nShots]);
        res=res+randn(size(res))*max(abs(resA(:)))/20;
    end

    if(~isfield(param,'ShowFig'))
        param.ShowFig=true;
    end
    StartTime_fnl=now;
    param.Verbose=false;
    clear ObjConv Score
    
    clf;
    
    for n=1:nfnlCgIters
        [res, CurObj] = fnlCg(res,param);
        ObjConv(n)=CurObj;
        im_res = param.XFM'*res;
        if(param.ShowFig)
%             figure(FigH); 
            subplot(1,3,1);
            gmontage(abs(gflip(im_res,[]))); drawnow;% title(qq)
            cx=caxis;
            caxis(cx/RunFnlViewAmp);
            subplot(1,3,2);
            gmontage(angle(gflip(im_res,[]))); drawnow;% title(qq)
            subplot(1,3,3);
            plot(ObjConv);setYaxis([0 CurObj*3]);if(n>1), setXaxis([1 n]);end
        end
        if(n>1)
            dObjP=(ObjConv(n-1)-CurObj)/ObjConv(n-1);
            disp(['Iter #' num2str(n,'%02d') ' ' datestr(now) ' ' num2str(CurObj,'%5.3g') ' dObjP ' num2str(dObjP,'%g')]);
            if(dObjP<1e-3)
                disp('Not advancing. Stopping.');
                break;
            end
        else
            disp(['Iter #' num2str(n,'%02d') ' ' datestr(now) ' ' num2str(CurObj,'%5.3g')]);
        end

        if(nShots==1)
            resA=res;
        end
    end
    
    im_resS(:,:,SliI)=im_res;
end
disp('Finished im_resS');
%%
fgmontage(im_resS)
title(['SparseMRI With TS 1map no CC']);

XFMStrFull=['[' XFMStr ',' num2str(filterSize) ',' num2str(wavScale) ',' num2str(xfmWeight) ']'];
XLbl=['L' num2str(param.pNorm) ',TVW=' num2str(param.TVWeight) ',' XFMStrFull ];
xlabel(XLbl)

gprint(get(gcf,'Number'),[ScanP BaseFN filesep 'SparseMRI_TS_1map_noCC_' XFMStrFull],[]) 
close(gcf);
%%
CurOurP=[ScanP BaseFN filesep];
mkdir(CurOurP);
save([CurOurP 'im_resS.mat'],'im_resS');
%% L1cgESPIRIT_CC on all:
% nMapsToUse=size(SensCC,4);
nMapsToUse=1;
for SliI=WhichSlices
    SensCC=squeeze(SensCCS(:,:,:,1:nMapsToUse,SliI));    
    TSBF=squeeze(TSBS(IB_TimeInMs2,:,SliI)).';
    GOP2S{SliI}=gpuNUFFT(BART2Fes_NUFT_Idxs(BARTTrajAct,Sz2)'/(2*pi),ones(size(BARTTrajAct,2),1),osf,wg,sw,Sz2,double(TSCS(:,:,:,SliI)));
    GOP_TSS{SliI}=ggpuNUFT_TS(GOP2S{SliI},double(TSBF));
    GOP_TS_ESPCCS{SliI}=ggpuNUFT_TS_MCnosum(GOP_TSS{SliI},[1 1 ncc]);
    
    weightsCC=ones(gsize(SensCC,[1 2 4]));
    ESPCCS{SliI} = ESPIRiT(SensCC,weightsCC);
end
disp('ok');
%%
clear resL1ESPIRiTCCS
%%
for SliI=WhichSlices
    disp(['Sli #' num2str(SliI) ' ' datestr(now)]);
    nukData=ADataIsPy(:,:,SliI,1).';
    nukData=nukData(:,3:end);
    DataCC=(sccmtxS(:,1:ncc,SliI).'*nukData);
    DataPCC=double(permute(DataCC,[3 2 1]));

    XOP = Wavelet('Daubechies_TI',4,6);
    splitWeight=0.5;
    lam=1e-7;
    nIterSplit=5e-4;
    % nIterSplit=15;
    [resL1ESPIRiTCCS(:,:,:,SliI)] = cgL1ESPIRiT(DataPCC, weightsCC*0, GOP_TS_ESPCCS{SliI}, ESPCCS{SliI}, 5,XOP,lam,splitWeight,nIterSplit);
end
disp('ok resL1ESPIRiTCCS');
%%
resL1ESPIRiTCCS1=squeeze(resL1ESPIRiTCCS(:,:,1,:));
fgmontage(resL1ESPIRiTCCS1,[0 7e-3])
title(['resL1ESPIRiT ' num2str(nMapsToUse) ' maps, B0, with CC -> ' num2str(ncc)]);
xlabel(['Daubechies_TI lam ' num2str(lam) ' splitWeight ' num2str(splitWeight)]);
%%
gprint(get(gcf,'Number'),[ScanP BaseFN filesep 'L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC' num2str(ncc)],[]) 
close(gcf);
save([ScanP BaseFN filesep 'L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC.mat'],'resL1ESPIRiTCCS1');
disp(['Saved ' ScanP BaseFN filesep 'L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC.mat']);
%% All reps
resL1ESPIRiTCCSA=zeros([size(weightsCC) nSlices nReps]);
%%
for SliI=WhichSlices
    for r=1:nReps
        disp(['Sli #' num2str(SliI) ' rep #' num2str(r) ' ' datestr(now)]);
        nukData=ADataIsPy(:,:,SliI,r).';
        nukData=nukData(:,3:end);
        DataCC=(sccmtxS(:,1:ncc,SliI).'*nukData);
        DataPCC=double(permute(DataCC,[3 2 1]));
        
        XOP = Wavelet('Daubechies_TI',4,6);
        splitWeight=0.5;
        lam=1e-6;
        nIterSplit=5e-4;
        % nIterSplit=15;
        [resL1ESPIRiTCCSA(:,:,:,SliI,r)] = cgL1ESPIRiT(DataPCC, weightsCC*0, GOP_TS_ESPCCS{SliI}, ESPCCS{SliI}, 5,XOP,lam,splitWeight,nIterSplit);
    end
end
disp('ok resL1ESPIRiTCCSA');
%%
resL1ESPIRiTCCS1A=squeeze(resL1ESPIRiTCCSA(:,:,1,:,:));
save([ScanP BaseFN filesep 'L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC_Allreps.mat'],'resL1ESPIRiTCCS1A');
disp(['Saved ' ScanP BaseFN filesep 'L1ESPIRiT_B0_lam' num2str(lam) T2SCompStr '_CC_Allreps.mat']);
%%








%% Call TF to get results
DBase=dir([ScanP BaseFN filesep 'RegridTry3C2_7TS*_train']);
for SliI=WhichSlices
    St=getParamsStructFromFN([ScanP BaseFN filesep DBase(1).name filesep]);
    St.LoadAndRunOnData=1;
    D=dir([ScanP BaseFN filesep 'RegridTry3C2_7TS_' ScanP(end-3:end-1) '_Sli' num2str(SliI,'%02d')  '*checkpoint*']);
    St.LoadAndRunOnData_checkpointP=[ScanP BaseFN filesep D.name];
    St.LoadAndRunOnData_Prefix=[ScanP BaseFN filesep 'RealData' filesep 'Sli' num2str(SliI) '_r'];
    St.LoadAndRunOnData_OutP=[ScanP BaseFN filesep 'RealDataOut' filesep 'Sli' num2str(SliI,'%02d') filesep];
    Txt=gStruct2txt(St,'~/HomeA/TF/Params.txt');
    % disp('Prepared Params');
    %
%     system('sudo -H -u a /media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
    system('sudo /home/deni/RunTFForMatlabx.sh');
end


%% Run already trained network on real data all reps
TrainNNRunP='/home/deni/TF/srez/RegridTry3C2_7TS_g18_Sli06__2018-08-16_12-35-57_train/';

St=getParamsStructFromFN(TrainNNRunP);
St.LoadAndRunOnData=1;
St.LoadAndRunOnData_checkpointP=[TrainNNRunP(1:end-6) 'checkpoint'];
St.LoadAndRunOnData_Prefix=[ScanP BaseFN filesep 'RealData' filesep 'Sli' num2str(SliI) '_r'];
St.LoadAndRunOnData_OutP=[ScanP BaseFN filesep 'RealDataOut' filesep 'Sli' num2str(SliI,'%02d') filesep];
% Txt=gStruct2txt(St,'~/HomeA/TF/Params.txt');
Txt=gStruct2txt(St,'~/TF/Params.txt');
%     system('sudo -H -u a /media/a/f38a5baa-d293-4a00-9f21-ea97f318f647/home/a/RunTFForMatlabx.sh');
system('sudo /home/deni/RunTFForMatlabx.sh');
%% Read NN output all reps
NNOutP='/media/deni/c78a9273-3214-4387-9f72-4cdc3adef255/OnBP_9Aug18/meas_MID488_gBP_ep2d_bold_multiecho_ASL_SMS_Spic_4min_FID26056/RealDataOut/Sli06/';
D=dir([NNOutP '*.mat']);
for r=1:numel(D)
    tmp=load([NNOutP D(r).name]);
    NNRec(:,:,r)=double(squeeze(tmp.x(1,:,:,1))+1i*squeeze(tmp.x(1,:,:,2)));
end
%%
MEven=NNRec(:,:,2:2:end);
MOdd=NNRec(:,:,1:2:end);
Perf=abs(MEven)-abs(MOdd);
MPerf=mean(Perf,3);
SPerf=std(Perf,0,3);
tSNR_Perf=MPerf./SPerf;